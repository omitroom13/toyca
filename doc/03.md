# 参考文献・メモ

正式なドキュメントにはあまり入れるべきでない、自分宛てメモ

## その他

### Ubuntu

Ubuntu で独自に認証局証明書を追加する場合、 /usr/local/share/ca-certificates 以下に置いてコマンド

```
sudo update-ca-certificates
```

で /etc/ca-certificates.conf に反映される。 curl や git はこれで対応できるようだ。

ホストのブラウザの以下を加える

- [debian環境のルート証明書を更新した話](https://kamatari.github.io/2015/03/12/how-to-install-root-certificate-on-debian/)
  - python の urllib
  - curl
- [ubuntuに自己認証局の証明書を登録](https://mistymagich.wordpress.com/2012/01/17/ubuntu%E3%81%AB%E8%87%AA%E5%B7%B1%E8%AA%8D%E8%A8%BC%E5%B1%80%E3%81%AE%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E7%99%BB%E9%8C%B2/)
  - git

### Firefox

- [Firefox 52以降でのルート証明書の自動インポート機能でできること、できないこと](http://www.clear-code.com/blog/2017/6/1.html)
  - Windows の場合は管理者がOSにインストールした証明書をインポートする機能があるようだ

## cipher suite

### AESGCM

[理解してるつもりの SSL/TLS でも、もっと理解したら面白かった話](http://tkengo.github.io/blog/2015/12/01/https-details/)
> 暗号化と同時に完全性や認証性も実現するための暗号方式 (たとえば GCM) が考案され、それらを総称して AEDA (Authenticated Encryption with Asocciated Data) と呼ばれます。暗号スイートの Mac の部分に AEAD という表記があるものは、暗号モードとして認証付き暗号の GCM が利用されています。

AESGCM とした場合 mac は指定せず 'ECDH+aRSA+AESGCM' などとするようだ。ECDH+aRSA+AESGCM+SHA256 としてもヒットしない。

```
$ openssl ciphers -v 'ECDH+aRSA+AESGCM'
ECDHE-RSA-AES256-GCM-SHA384 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AESGCM(256) Mac=AEAD
ECDHE-RSA-AES128-GCM-SHA256 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AESGCM(128) Mac=AEAD

$ openssl ciphers -v 'ECDH+aRSA+AESGCM+AEAD'
Error in cipher list
139825319563712:error:1410D0B9:SSL routines:SSL_CTX_set_cipher_list:no cipher match:../ssl/ssl_lib.c:2129:

$ openssl ciphers -v 'ECDH+aRSA+AESGCM+SHA'
Error in cipher list
140489317126592:error:1410D0B9:SSL routines:SSL_CTX_set_cipher_list:no cipher match:../ssl/ssl_lib.c:2129:
```

openssl ciphers -v で表示される名前は openssl の通称であって、他のソフトウェアで通用するかどうか不明。正式(RFC?)な名称との対応は man openssl ciphers で確認できる

### 盗聴可能＆不可能

### クライアントで接続可 or 不可が別れる微妙な例

```
$ openssl ciphers -v -tls1_2 'kRSA+aRSA+AES256+SHA256'
AES256-SHA256           TLSv1.2 Kx=RSA      Au=RSA  Enc=AES(256)  Mac=SHA256
$ man openssl ciphers
#(AES256-SHA256=TLS_RSA_WITH_AES_256_CBC_SHA256 とわかる)
```

wget は ok

```
wget https://ca.example.com:7443/
```

chrome は ng

```
このサイトは安全に接続できません ca.example.com ではサポートされていないプロトコルが使用されています。
ERR_SSL_VERSION_OR_CIPHER_MISMATCH
```

以下なら wget / chrome ともに ok

```
$ openssl ciphers -v -tls1_2 'kRSA+aRSA+AESGCM'
AES256-GCM-SHA384       TLSv1.2 Kx=RSA      Au=RSA  Enc=AESGCM(256) Mac=AEAD
AES128-GCM-SHA256       TLSv1.2 Kx=RSA      Au=RSA  Enc=AESGCM(128) Mac=AEAD
#(AES256-GCM-SHA384=TLS_RSA_WITH_AES_256_GCM_SHA384)
#(AES128-GCM-SHA256=TLS_RSA_WITH_AES_128_GCM_SHA256)
```

### tcpdump からの tshark 

```
sudo echo "バックグラウンドで tdpdump を実行するのでここで認可させる"
sudo tcpdump -s 0 -w /tmp/test.pcap -i lo host localhost and port 7443 &
pid=$!
curl https://ca.example.com:7443/
sudo kill -INT $pid
```

```
ssl_handshake_type=$(tshark -r /tmp/test.pcap -T fields -e ssl.handshake.ciphersuite 'ssl.handshake.type == 2')
ssl_handshake_type_hex=0x00$(echo "obase=16; $ssl_handshake_type" | bc | tr 'A-E' 'a-e')
tshark -r /tmp/test.pcap -V 'ssl.handshake.type == 2' | grep $ssl_handshake_type_hex
```

これで TLS_RSA_WITH_AES_256_GCM_SHA384 が使用されていることがわかる

### tls 復号

復号可能なら html の内容を表示できる

```
tshark -r /tmp/test.pcap -o ssl.keys_list:"127.0.0.1","443","http",./ca/server-ca-2/certs/ca.example.com/key-nopass.pem -o ssl.debug_file:"ssl-debug.log" -V -Y http
```


日本語がコードで表示されていたり、[truncated]　と表示されたりするのは tshark 側?

## tshark の出力とテスト

必要な部分をピンポイントで取り出すことができるのでテストを動かすときにはよいが、テストを作るときには意味の説明がないので厳しいな。
テストを作るときには wireshark でフィールドを確認して、tshark の値をテストに組み込む感じかな。 これはテストコードを読めばわかるようなものではないので、 server hello(ssl.handshake.ciphresuite == 2) の ssl.handshake.ciphersuite は Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 = 0x009d = 157 であることとか書かないといけないな。wireshark から該当情報選んでコンテキストメニュー/コピー/全ての見えている選択されたツリー項目 でコピーできる

これをやらずに tshark の検索式を作ったりすることは不可能だな。

- RFC や ggrks でプロトコル仕様上の参照すべき情報を確認する
- コマンド動作させてキャプチャする
- wireshark で参照すべき情報を含むパケットを見つける
- 参照すべき情報をポイントし、表示される属性名を確認する
- パケットを特定するフィルタと出力データを考案する
- フィルタの確認

```
wireshark -Y "ssl.handshake.type == 2" /tmp/test.pcap
tshark -r /tmp/test.pcap -V 'ssl.handshake.type == 2'
```


## これどういう意味なんだ? tls1_2 指定なのに sslv3 とは...

```
$ openssl ciphers -v -tls1_2 'kRSA+aRSA+AES256+SHA'
AES256-SHA              SSLv3 Kx=RSA      Au=RSA  Enc=AES(256)  Mac=SHA1
```

## cipher suite

今の所これ選んでおけば? なもの

```
$ openssl ciphers -v -tls1_3 'kECDHE+aECDSA+CHACHA20'
TLS_AES_256_GCM_SHA384  TLSv1.3 Kx=any      Au=any  Enc=AESGCM(256) Mac=AEAD
TLS_CHACHA20_POLY1305_SHA256 TLSv1.3 Kx=any      Au=any  Enc=CHACHA20/POLY1305(256) Mac=AEAD
TLS_AES_128_GCM_SHA256  TLSv1.3 Kx=any      Au=any  Enc=AESGCM(128) Mac=AEAD
ECDHE-ECDSA-CHACHA20-POLY1305 TLSv1.2 Kx=ECDH     Au=ECDSA Enc=CHACHA20/POLY1305(256) Mac=AEAD
```

openssl 1.1.1 でないと、 1.3 の TLS* はでない。

## chrome の cipher suite 設定

ブラックリスト指定できる

[Google ChromeのSSL/TLS暗号化アルゴリズム設定](https://tosi-tech.net/2014/07/ssl-argorithm-config-on-chrome/)


## wireshark のヘルプ

提示される TLS メッセージタイプの検索式がおかしい。GUI で人が目で見るから気にされない領域になってくると、ヘルプがおかしいのかもしれない。

![タイプの説明がおかしい](2019-03-10T20-41-55.png)

## squid bumping

```
SSL Bump does Man-In-The-Middle attack on the HTTPS connections when Squid contacts remote HTTPS server on your behalf and then mimics secure connection by faking the remote site certificate and signing it with the configured self sign root key. You also must install this self signed root certificate as trusted in all your browsers.
```

[squid3 ssl bumping server-first with signed certificate](https://serverfault.com/questions/649976/squid3-ssl-bumping-server-first-with-signed-certificate)

> 1 In order to do the SSL Bump you must be using a self signed root certificate file. The one you mentioned from Comodo will never work.

root じゃないとダメってまじかよ? これに反する材料は見つからなかった。

proxy_1  | FATAL: No valid signing SSL certificate configured for HTTP_port [::]:3128

特に自己署名でなくても復号できた。 squid コンテナは bump が有効になっていたが(ubuntu 等の squid は無効)、squid 証明書データベースを初期化したり、証明書のパーミッションを設定したりでイメージを作る必要がある。


```
docker run -it -v $(pwd):/opt/toyca openssl-tls1_3
```

```

```

```
docker-compose up

(別コンソールで実行)
export https_proxy=localhost:3128
wget https://www.google.com
```

kali の squid は 4?

```
squid -v | grep crtd
```

--enable-ssl-crtd が必要。入ってない...コンテナは入っているのね

tls-cert PEM
tls-key

- bundle?
- DER?
- root?
- extension?

(Help getting Squid 3.4 Transparent Proxy to Work)[https://squid-users.squid-cache.narkive.com/xo5G8ghQ/help-getting-squid-3-4-transparent-proxy-to-work]

## 参考

- [cipher suite の設定例](https://www.cdnetworks.co.jp/blog/6516/)
- [TLS1.2が使えない環境のためのProxy (squid)設定](http://kikumoto.hatenablog.com/entry/2016/06/04/124922)
  - 透過 squid 


## TLS 1.3

- [ウェブサーバのTLS ChaCha20-Poly1305で通信させたい](https://gato.intaa.net/archives/12813)
  - ECDHE-ECDSA-CHACHA20-POLY1305
  - は追加したいな
- [「SSL/TLS暗号設定ガイドライン 第2.0版」を読んで](https://jovi0608.hatenablog.com/entry/2018/05/09/213703)
- [[レポート] TLS 1.3 の標準化動向 #tls13_study ※補足説明付き](https://dev.classmethod.jp/study_meeting/report-tls13-study-201802/)
- [Enabling TLS 1.3 support in nginx](https://blog.bejarano.io/enabling-tls13-support-in-nginx.html)
  - nginx 1.13.0 or higher


```
nginx -v
```

TLS1.3 な nginx に 

```
wget --version
# openssl のバージョンはなく、1.19.4 であることだけしかわからない。

curl --version 
curl 7.58.0 (x86_64-pc-linux-gnu) libcurl/7.58.0 OpenSSL/1.1.0g zlib/1.2.11 libidn2/2.0.4 libpsl/0.19.1 (+libidn2/2.0.4) nghttp2/1.30.0 librtmp/2.3
Release-Date: 2018-01-24
Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtmp rtsp smb smbs smtp smtps telnet tftp 
Features: AsynchDNS IDN IPv6 Largefile GSS-API Kerberos SPNEGO NTLM NTLM_WB SSL libz TLS-SRP HTTP2 UnixSockets HTTPS-proxy PSL 
```



```
OpenSSL: error:1409442E:SSL routines:ssl3_read_bytes:tlsv1 alert protocol version
```

chrome のエラー

```
ca.example.com ではサポートされていないプロトコルが使用されています。
ERR_SSL_VERSION_OR_CIPHER_MISMATCH
```

```
ca.example.com では、悪意のあるユーザーによって、パスワード、メッセージ、クレジット カードなどの情報が盗まれる可能性があります。詳細
NET::ERR_CERT_COMMON_NAME_INVALID
```


EdSA 秘密鍵

```
openssl genpkey -algorithm ED25519 -out 秘密鍵ファイル名.pem
openssl genpkey -algorithm ED448 -out 秘密鍵ファイル名.pem
```

- [Create a self-signed ECC certificate](https://msol.io/blog/tech/create-a-self-signed-ecc-certificate/)
  - ecc は証明書が作成できる
- 

## nginx エラー

こういうのがでない

```
www_1      | 2019/03/15 06:08:46 [emerg] 1#1: cannot load certificate "/etc/ssl/toyca/server-ca-2/certs/ca.example.com/cert-im.pem": BIO_new_file() failed (SSL: error:02001002:system library:fopen:No such file or directory:fopen('/etc/ssl/toyca/server-ca-2/certs/ca.example.com/cert-im.pem','r') error:2006D080:BIO routines:BIO_new_file:no such file)
www_1      | nginx: [emerg] cannot load certificate "/etc/ssl/toyca/server-ca-2/certs/ca.example.com/cert-im.pem": BIO_new_file() failed (SSL: error:02001002:system library:fopen:No such file or directory:fopen('/etc/ssl/toyca/server-ca-2/certs/ca.example.com/cert-im.pem','r') error:2006D080:BIO routines:BIO_new_file:no such file)
www_1      | 2019/03/15 06:19:13 [emerg] 1#1: cannot load certificate key "/etc/ssl/toyca/server-ca-2/certs/ca.example.com/key-nopass.pem": BIO_new_file() failed (SSL: error:02001002:system library:fopen:No such file or directory:fopen('/etc/ssl/toyca/server-ca-2/certs/ca.example.com/key-nopass.pem','r') error:2006D080:BIO routines:BIO_new_file:no such file)
```

### nginx.conf 設定変えた場合

```
./ca.sh gen_nginx_conf
docker restart dockerfile_www_1
```
